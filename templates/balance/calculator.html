{% extends "base.html" %}
{% load permissions %}
{% block title %}Stan kasy{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">

  <h1 class="mb-0">Stan kasy</h1>

  {% if last_count %}
  <button class="btn btn-outline-warning btn-sm fw-semibold"
          data-bs-toggle="collapse"
          data-bs-target="#lastBalance">
    Ostatni stan kasy
  </button>
  {% endif %}

</div>

{% if last_count %}
<div id="lastBalance" class="collapse mb-4">

  <div class="card card-body">

    <p class="mb-1">
      <strong>{{ last_count.total }} zł</strong>
    </p>

    <small class="text-muted">
      {{ last_count.created_at|date:"d.m.Y H:i" }}
      · {{ last_count.user }}
    </small>

  </div>

</div>
{% endif %}

<form method="post">
  {% csrf_token %}

  <div class="row g-3">

    {% for field in form %}
      <div class="col-6 col-md-3">
        <label class="form-label">
          {{ field.label }}
        </label>
        {{ field }}
      </div>
    {% endfor %}

  </div>

  
    {% if request.user|can:"balance_calculate" %}
        <button type="submit" class="btn btn-primary mt-3">
            Oblicz
        </button>
    {% endif %}

</form>


{% if saved_total %}
<div class="modal fade" id="balanceModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Twój stan kasy</h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <p><strong>Stan kasy:</strong></p>

        <div class="input-group">
          <input id="savedTotal"
                 class="form-control"
                 value="{{ saved_total }}"
                 readonly>

          <button class="btn btn-outline-secondary"
                  type="button"
                  onclick="copyBalance()">
            Kopiuj
          </button>
        </div>

      </div>
      <div class="modal-body text-center">
        <p class="fw-semibold">
          Czy chcesz przejść do raportu zamknięcia zmiany?
        </p>
      </div>

      <div class="modal-footer justify-content-center">

        <button class="btn btn-outline-light"
                data-bs-dismiss="modal">
          Zostań tutaj
        </button>

        <a href="{% url 'reports:shift_close_form' %}?prefill={{ saved_total }}"
           class="btn btn-primary">
          Przejdź do raportu
        </a>
    </div>
  </div>
</div>
{% endif %}


{% endblock %}
{% block scripts %}
{% if saved_total %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const modal = new bootstrap.Modal(
    document.getElementById("balanceModal")
  );
  modal.show();
});

function copyBalance() {
  const input = document.getElementById("savedTotal");
  input.select();
  input.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(input.value);
}
</script>
{% endif %}

{% endblock %}